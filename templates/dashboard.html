<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - DR Analyzer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8fafc; --card: #ffffff; --accent: #0f172a; --primary: #0066cc;
      --muted: #94a3b8; --radius: 16px; --good: #10b981; --warn: #f59e0b; --bad: #ef4444;
    }
    * { box-sizing: border-box; transition: all 0.2s ease-in-out; }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; line-height: 1.5; }
    
    header { 
        background: #fff; color: var(--accent); padding: 15px 0; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); border-bottom: 1px solid #e2e8f0;
        position: sticky; top: 0; z-index: 100;
    }
    header .container { display: flex; align-items: center; justify-content: space-between; }
    
    .container { max-width: 1200px; margin: 30px auto; padding: 0 24px; }
    .card { 
        background: var(--card); border-radius: var(--radius); 
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); 
        padding: 24px; border: 1px solid #f1f5f9;
    }
    .grid { display: grid; grid-template-columns: 1fr 340px; gap: 30px; }
    
    .title { font-size: 20px; font-weight: 800; color: var(--accent); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .title::before { content: ''; width: 4px; height: 20px; background: var(--primary); border-radius: 4px; }

    .stat { 
        flex: 1; background: #fff; padding: 20px; border-radius: 16px; 
        border: 1px solid #f1f5f9; position: relative; overflow: hidden;
    }
    .stat::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: var(--primary); opacity: 0.1; }
    .stat div:first-child { font-size: 32px; font-weight: 800; color: var(--primary); }

    .btn { 
        padding: 12px 20px; border-radius: 12px; border: none; font-weight: 700; 
        background: var(--primary); color: white; cursor: pointer; font-size: 14px;
        display: inline-flex; align-items: center; justify-content: center;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,102,204,0.3); }

    table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    th { text-transform: uppercase; font-size: 12px; letter-spacing: 0.05em; color: var(--muted); padding: 12px; }
    td { background: #fff; padding: 16px; border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; }
    td:first-child { border-left: 1px solid #f1f5f9; border-radius: 12px 0 0 12px; }
    td:last-child { border-right: 1px solid #f1f5f9; border-radius: 0 12px 12px 0; }

    /* Result Area Enhancements */
    .result-wrap { 
        margin-top: 24px; background: #f1f5f9; padding: 20px; border-radius: 20px; 
        animation: fadeIn 0.5s ease;
    }
    .preview { 
        width: 240px; height: 240px; border-radius: 16px; 
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 4px solid #fff;
    }
    .result-card { 
        background: #fff; border-radius: 16px; padding: 24px; 
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
    }
    .severity-badge { font-size: 14px; padding: 8px 16px; letter-spacing: 0.5px; }
    #severity-text {
    font-size: 20px;
    font-weight: 800;
    padding: 10px 20px;
    border-radius: 12px;
    color: white;
    display: inline-block;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 8px;
    min-width: 140px;
    text-align: center;
  }
    
    .severity-0 { background: var(--good); }
    .severity-1 { background: #3b82f6; }
    .severity-2 { background: var(--warn); }
    .severity-3 { background: #f97316; }
    .severity-4 { background: var(--bad); }

    header .container.header-flex {
    display: flex;
    justify-content: space-between; /* Isse title left aur actions right ho jayenge */
    align-items: center;
    width: 100%;
    max-width: 1200px; /* Dashboard ki width ke hisaab se */
}

.logo {
    font-weight: 800;
    font-size: 22px;
    color: var(--primary);
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 20px; /* Button aur Profile ke beech ki gap */
}

/* Dropdown ko properly dikhane ke liye zaroori CSS */
.dropdown-menu.active {
    display: block !important;
}

    /* Profile Dropdown Styles */
  .user-menu-container {
    position: relative;
    display: inline-block;
  }

  .profile-trigger {
    width: 40px;
    height: 40px;
    background: #eef2f7;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    overflow: hidden;
  }

  .profile-trigger:hover {
    border-color: var(--primary);
    box-shadow: 0 0 10px rgba(0, 102, 204, 0.2);
  }

  .profile-trigger img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .dropdown-menu {
    position: absolute;
    top: 50px;
    right: 0;
    width: 220px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    border: 1px solid #eef2f7;
    display: none; /* Hidden by default */
    z-index: 1000;
    padding: 8px 0;
    animation: slideDown 0.3s ease;
  }

  .dropdown-menu.active {
    display: block !important;
    animation: slidedown 0.3s ease;
  }

  .dropdown-header {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f5f9;
    margin-bottom: 8px;
  }

  .dropdown-item {
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #475569;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: background 0.2s;
    cursor: pointer;
  }

  .dropdown-item:hover {
    background: #f8fafc;
    color: var(--primary);
  }

  .dropdown-item.logout-btn {
    color: var(--bad);
  }

  .dropdown-item.logout-btn:hover {
    background: #fff1f2;
  }



    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
  <header>
  <div class="container header-flex">
    <div class="logo">DR Analyzer</div>
    
    <div class="header-actions">
      
      <div class="user-menu-container">
        <div class="profile-trigger" id="profileTrigger">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        
        <div class="dropdown-menu" id="dropdownMenu">
          <div class="dropdown-header">
            <div style="font-weight: 700; color: #1e293b">{{ username }}</div>
            <div style="font-size: 12px; color: #94a3b8">Patient ID: DR-2025-01</div>
          </div>
          <div class="dropdown-item" onclick="showAccountInfo()">My Account</div>
          <hr style="border: 0; border-top: 1px solid #f1f5f9; margin: 4px 0;">
          <div class="dropdown-item logout-btn" id="dropdown-logout">Logout</div>
        </div>
      </div>
    </div>
  </div>
</header>

  <main class="container">
    <div class="grid" style="margin-bottom:18px">
      <div>
        <div class="card">
          <div class="title">Recent scans</div>
          <table id="scans-table">
            <thead><tr><th>File</th><th>Date</th><th>Result</th></tr></thead>
            <tbody>
              <tr><td>eye_001.jpg</td><td>2025-10-12</td><td><strong>Moderate</strong></td></tr>
              <tr><td>eye_002.jpg</td><td>2025-09-21</td><td><strong>Mild</strong></td></tr>
            </tbody>
          </table>

          <!-- Result + Preview block -->
          <div id="result-area" class="result-wrap" style="display:none">
            <div class="preview" id="img-preview"><span class="small-muted">No preview</span></div>
            <div class="result-card" id="result-card">
              <div class="small-muted">Analysis result</div>
              <div id="additional-info" class="small-muted">No details yet</div>
              <div style="display:flex; justify-content:space-between; align-items:center">
                <div>
                  <div id="severity-text" class="severity-badge severity-0" style="margin-top:6px; display:inline-block;"></div>
                </div>
                <div id="severity-badge" style="display:none"></div> 
              </div>
              
              <div style="margin-top:auto; display:flex; gap:8px;">
                <button id="save-btn" class="btn" style="width:auto;padding:8px 12px">Save result</button>
                <button id="re-run" class="btn" style="background:transparent;color:var(--accent2);border:1px solid #e6ecf8">Re-run</button>
              </div>
            </div>
          </div>
        </div>

        <div style="height:18px"></div>
        <div class="card">
          <div class="title">Statistics</div>
          <div class="overview">
            <div class="stat"><div style="font-size:26px; font-weight:800">124</div><div class="muted">Analyses this month</div></div>
            <div class="stat"><div style="font-size:26px; font-weight:800">19</div><div class="muted">Abnormal findings</div></div>
            <div class="stat"><div style="font-size:26px; font-weight:800">3</div><div class="muted">Saved reports</div></div>
          </div>
        </div>
      </div>

      <aside>
        <div class="card">
          <div class="title">Account</div>
          <div class="muted">Username: demo_user</div>
          <div style="height:12px"></div>
          <div class="muted">Plan: Free</div>
        </div>

        <div style="height:12px"></div>
        <div class="card">
          <div class="title">Quick actions</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button id="btn-upload" class="btn">Upload image</button>
            <button id="btn-viewall" class="btn" style="background:#f5f7fb;color:var(--accent2);box-shadow:none;border:1px solid #e6ecf8">View all</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- hidden file input -->
  <input id="file-picker" type="file" accept="image/*" style="display:none" />

  <div class="top-result" id="top-result">Result shown</div>

<script>
/* --- 1. Variables aur IDs --- */
const btnNew = document.getElementById('btn-new');
const btnUpload = document.getElementById('btn-upload');
const filePicker = document.getElementById('file-picker');
const resultArea = document.getElementById('result-area');
const imgPreview = document.getElementById('img-preview');
const severityText = document.getElementById('severity-text');
const severityBadge = document.getElementById('severity-badge');
const additionalInfo = document.getElementById('additional-info');
const scansTable = document.getElementById('scans-table').querySelector('tbody');
const topResult = document.getElementById('top-result');

const profileTrigger = document.getElementById('profileTrigger');
const dropdownMenu = document.getElementById('dropdownMenu');
const dropdownLogout = document.getElementById('dropdown-logout');

const severityMap = {
  0: { label: "No DR", cls: "severity-0" },
  1: { label: "Mild DR", cls: "severity-1" },
  2: { label: "Moderate DR", cls: "severity-2" },
  3: { label: "Severe DR", cls: "severity-3" },
  4: { label: "Proliferative DR", cls: "severity-4" }
};

/* --- 2. Profile Dropdown Logic --- */
if (profileTrigger && dropdownMenu) {
    profileTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('active');
    });
    document.addEventListener('click', () => dropdownMenu.classList.remove('active'));
}

if (dropdownLogout) {
    dropdownLogout.addEventListener('click', () => location.href = '/logout');
}

function showAccountInfo() {
    alert(`Account Profile\n-------------------\nUsername: {{ username }}\nPlan: Free Tier\nStatus: Active`);
}

/* --- 3. Upload aur Prediction Logic --- */

if(btnUpload) btnUpload.addEventListener('click', () => filePicker.click());

filePicker.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  // Preview dikhayein
  const objectUrl = URL.createObjectURL(file);
  imgPreview.innerHTML = `<img src="${objectUrl}" style="max-width:100%; border-radius:10px;">`;
  
  resultArea.style.display = 'flex';
  severityText.textContent = 'Analyzing...';
  severityBadge.textContent = 'Wait...';
  additionalInfo.textContent = 'Processing image...';

  const fd = new FormData();
  fd.append('file', file);

  try {
    const resp = await fetch('/predict', { method: 'POST', body: fd });
    
    if(!resp.ok) {
        const err = await resp.json();
        additionalInfo.textContent = err.error || 'Invalid Image';
        severityText.textContent = "Error";
        severityBadge.textContent = "Rejected";
        severityBadge.className = 'severity-badge severity-4';
        return;
    }

    const json = await resp.json();
    const level = json.severity_level;
    const map = severityMap[level] || severityMap[0];

    additionalInfo.textContent = `DR Detected: ${json.dr_detected ? 'Yes' : 'No'}`;
    severityText.textContent = map.label;
    severityText.className = 'severity-badge ' + map.cls;

    // Recent Scans Table mein add karein
    const row = scansTable.insertRow(0);
    row.innerHTML = `<td>${file.name}</td><td>${new Date().toLocaleDateString()}</td><td><strong>${json.severity}</strong></td>`;

  } catch(err) {
    console.error(err);
    additionalInfo.textContent = 'Connection Error';
  } finally {
    filePicker.value = ''; // Input clear karein
  }
});
</script>
</body>
</html>
